#include <Keypad.h>
#include <Arduino.h>
#include <TM1637Display.h>

#define CLK A0
#define DIO A1
const byte ROWS = 4; //four rows
const byte COLS = 4; //four columns
//define the cymbols on the buttons of the keypads
#define segG 10  // Gpin을 10에 연결


char customKey;
char hexaKeys[ROWS][COLS] = {
  {'1', '2', '3', 'A'},
  {'4', '5', '6', 'B'},
  {'7', '8', '9', 'C'},
  {'*', '0', '#', 'D'}
};
byte rowPins[ROWS] = {9, 8, 7, 6}; //connect to the row pinouts of the keypad
byte colPins[COLS] = {5, 4, 3, 2}; //connect to the column pinouts of the keypad


double first =0;
double second = 0;
double result = 0;
double aa = 0;
char cal;


Keypad customKeypad = Keypad( makeKeymap(hexaKeys), rowPins, colPins, ROWS, COLS);

TM1637Display display(CLK, DIO);

void setup() {
  display.setBrightness(0x0f);
  display.showNumberDec(0, false);
  pinMode(segG, OUTPUT);
} 

void loop() {
 customKey = customKeypad.getKey();

  operation1();
  dummy_calculate();
  operation2();
  calculate();
  
  if(customKey == '#'){  // 등호 function
    if(result> 9999 || result < -9999){
        result = 0;
        aa = true;
      }
      else{
        aa = false;
      }
     if(result < 0){
       digitalWrite(segG, LOW);
     }
     else  digitalWrite(segG, HIGH);
    display.showNumberDec(result, aa);
    first = 0;
    second = 0;
    result = 0;
   

  }
}

void clean(){
  first = 0;
  second = 0;
  result = 0;
  cal = NULL;
}

int operation1() {
 while(1){
  customKey = customKeypad.getKey();
    if (customKey >= '0' && customKey <= '9') {
     first = (first*10) + (customKey - '0');

       if(first > 9999 || first < -9999){
        first = 0;
        aa = true;
       }
       else{
        aa = false;
       }
       if(result < 0){
        digitalWrite(segG, LOW);
       }
       else digitalWrite(segG, HIGH);
     display.showNumberDec(first, aa);   
    }  
    if(customKey == 'A') break;
    else if(customKey == 'B') break;
    else if(customKey == 'C') break;
    else if(customKey == 'D') break;
    else if (customKey == '*') clean();

 }
 return first;
}

int operation2() {
 while(1){
   customKey = customKeypad.getKey();
    if (customKey >= '0' && customKey <= '9') {
      second = (second*10) + (customKey - '0');
  
       if(second > 9999 || second < -9999){
        second = 0;
        aa = true;
       }
       else{
        aa = false;
       }
       if(result < 0){
         digitalWrite(segG, LOW);
       }
       else  digitalWrite(segG, HIGH);
       
     display.showNumberDec(second, aa);
    }  
    if(customKey == '#') break; 
    else if(customKey == '*') clean();
   }
 return second;
}

void calculate(){
  switch(cal){
     case 'A' :
       result = first + second;
       break;
     case 'B' :
       result = first - second;
       break;
     case 'C' :
       result = first * second;
       break;
     case 'D' :
       result = first / second;
       break;
    }
}

void dummy_calculate(){
  switch(customKey){
   customKey = customKeypad.getKey();
     case 'A' :
       cal = 'A';
       break;
     case 'B' :
       cal = 'B';
       break;
     case 'C' :
       cal = 'C';
       break;
     case 'D' :
       cal = 'D';
       break;
    }
}
